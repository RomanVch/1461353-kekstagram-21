(()=>{"use strict";window.backend={load:(e,t)=>{const n=new XMLHttpRequest;n.responseType="json",n.open("GET","https://21.javascript.pages.academy/kekstagram/data"),n.addEventListener("load",(()=>{let o;switch(n.status){case 200:e(n.response);break;case 400:o="Неверный запрос";break;case 401:o="Пользователь не авторизован";break;case 404:o="Ничего не найдено";break;default:o="Cтатус ответа: : "+n.status+" "+n.statusText}o&&t(o)})),n.addEventListener("error",(()=>{t(n.status)})),n.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+n.timeout+"мс")})),n.timeout=1e4,n.send()},send:(e,t,n)=>{const o=new XMLHttpRequest;o.responseType="json",o.open("POST","https://21.javascript.pages.academy/kekstagram"),o.addEventListener("load",(()=>{200===o.status?t(o.response):n(o.status)})),o.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),o.send(e)}},(()=>{let e=null;window.debounce=t=>(...n)=>{e&&window.clearTimeout(e),e=window.setTimeout((()=>{t(...n)}),500)}})(),(()=>{const e=100,t=document.querySelector(".img-upload__input"),n=document.querySelector(".img-upload"),o=n.querySelector(".img-upload__effect-level"),s=n.querySelectorAll(".effects__radio"),r=n.querySelector("#prewiew__foto"),i=document.body,c=n.querySelector("#upload-cancel"),l=document.querySelector("#upload-file"),d=document.querySelector(".img-upload__overlay"),a=["","grayscale(1)","sepia(1)","invert(100%)","blur(3px)","brightness(3)"];let u=null;const m=["none","effects__preview--chrome","effects__preview--sepia","effects__preview--marvin","effects__preview--phobos","effects__preview--heat"],v=n.querySelector(".effect-level__line"),p=n.querySelector(".effect-level__pin"),y=n.querySelector(".effect-level__depth"),g=n.querySelector(".effect-level__value");let f=25;o.classList.add("hidden");const w=n.querySelector(".scale__control--smaller"),h=n.querySelector(".scale__control--bigger"),L=n.querySelector(".scale__control--value"),_=n.querySelector(".img-upload__preview");let E=100;const k=()=>{_.style.transform="scale(1)",E=100,s[0].checked=!0,window.validation.hashtag.value="",window.validation.commentPhoto.value="",r.style.filter="",r.className="",o.classList.add("hidden"),t.value="",d.classList.add("hidden"),l.value="",L.value="100%",g.value="100"},S=()=>{E>26?(E-=25,L.value=E+"%",_.style.transform=`scale(${E/e})`):(E=25,L.value=E+"%",_.style.transform=`scale(${E/e})`)},b=()=>{E<e?(E+=25,L.value=E+"%",_.style.transform=`scale(${E/e})`):(E=e,L.value=E+"%",_.style.transform=`scale(${E/e})`)};for(let t=0;t<s.length;t++){const n=()=>{r.className="",o.classList.remove("hidden"),r.classList.add(m[t]);for(let t=0;t<a.length;t++)r.classList.contains(m[t])?r.style.filter=a[t]:f!==e?(f=e,p.style.left="100%",y.style.width="100%"):s[0].checked&&(r.className="",o.classList.add("hidden"),r.style.filter="")};s[t].addEventListener("change",n)}const q=()=>{u=e=>{e.preventDefault(),document.body.addEventListener("mousemove",n),document.addEventListener("mouseup",o)};const t=t=>{const n=v.getBoundingClientRect().right,o=v.getBoundingClientRect().left;let r=t.clientX;r>n?r=n:r<o&&(r=o),f=parseInt((r-o)*e/(n-o),10),q.shift=parseInt((r-o)*e/(n-o),10),p.style.left=f+"%",y.style.width=f+"%",g.value=f,document.addEventListener("mousemove",s)},n=t=>{const n=v.getBoundingClientRect().right,o=v.getBoundingClientRect().left;let r=t.clientX;r>n?r=n:r<o&&(r=o),f=parseInt((r-o)*e/(n-o),10),q.shift=parseInt((r-o)*e/(n-o),10),p.style.left=f+"%",y.style.width=f+"%",g.value=f,document.addEventListener("mousemove",s)},o=e=>{e.preventDefault(),document.body.removeEventListener("mousemove",n),document.removeEventListener("mouseup",o),document.removeEventListener("mousemove",s)},s=()=>{const t=["",`grayscale(${f/e})`,`sepia(${f/e})`,`invert(${f}%)`,`blur(${f/33.3333}px)`,`brightness(${1+f/50})`];for(let e=0;e<t.length;e++)r.classList.contains(m[e])&&(r.style.filter=t[e])},a=()=>{k(),i.classList.remove("modal-open"),w.removeEventListener("click",S),h.removeEventListener("click",b),p.removeEventListener("mousedown",u),g.removeEventListener("click",t),document.removeEventListener("keydown",L)},L=e=>{document.activeElement!==window.validation.hashtag&&e.key===window.render.ESCAPE&&document.activeElement!==window.validation.commentPhoto&&e.key===window.render.ESCAPE&&(e.preventDefault(),a())};return l.addEventListener("change",(()=>{d.classList.remove("hidden"),i.classList.add("modal-open"),document.addEventListener("keydown",L),w.addEventListener("click",S),h.addEventListener("click",b),p.addEventListener("mousedown",u),g.addEventListener("click",t)})),c.addEventListener("click",(()=>{a()})),p.addEventListener("mousedown",u),g.addEventListener("click",t),{shift:f,effectLevelPin:p,effectLevelDepth:y,onDocumentKeydown:L}};q(),window.form={imgUpload:n,startInitialSettings:k,imgUploadOverlay:d,uploadFile:l,demonstrationPhoto:r}})(),(()=>{const e="Enter",t=document.querySelector(".pictures"),n=document.querySelector(".img-filters"),o=n.querySelector("#filter-random"),s=n.querySelector("#filter-default"),r=n.querySelector("#filter-discussed");let i=[],c=[],l=[],d=[];const a=(n,o)=>{const s=document.createDocumentFragment(),r=document.querySelectorAll(".picture");for(let e=0;e<r.length;e++)r[e].remove();for(let t=0;t<o;t++){const o=window.render.renderPicture(n[t]),r=o.querySelector(".picture"),i=e=>{e.preventDefault(),window.render.bigPictureRender(n[t]),window.render.bigPicture.classList.remove("hidden"),document.body.classList.add("modal-open")},c=t=>{t.key===e&&i()};r.addEventListener("keydown",c),r.addEventListener("click",i),s.appendChild(o)}t.appendChild(s)};window.backend.load((o=>{i=o,d=o.slice();const s=document.createDocumentFragment();o.forEach((t=>{const n=window.render.renderPicture(t),o=n.querySelector(".picture");s.appendChild(n),o.addEventListener("keydown",(n=>{n.key===e&&(n.preventDefault(),window.render.bigPictureRender(t),window.render.bigPicture.classList.remove("hidden"),document.body.classList.add("modal-open"))})),o.addEventListener("click",(()=>{window.render.bigPictureRender(t),window.render.bigPicture.classList.remove("hidden"),document.body.classList.add("modal-open")}))})),n.classList.remove("img-filters--inactive"),t.appendChild(s)}),(e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: pink;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="20px",t.style.color="black",t.textContent="ошибка: "+e,document.body.insertAdjacentElement("afterbegin",t)})),o.addEventListener("click",window.debounce((()=>{for(let t=0;t<i.length;t++)c.push(i[Math.floor((0,e=i.length-1,Math.random()*(e-0+1)+0))]),l=[...new Set(c)];var e;a(l,10),o.classList.add("img-filters__button--active"),s.classList.remove("img-filters__button--active"),r.classList.remove("img-filters__button--active"),c=[]}))),s.addEventListener("click",window.debounce((()=>{a(i,i.length),o.classList.remove("img-filters__button--active"),s.classList.add("img-filters__button--active"),r.classList.remove("img-filters__button--active")}))),r.addEventListener("click",window.debounce((()=>{d.sort(((e,t)=>t.comments.length-e.comments.length)),a(d,d.length),o.classList.remove("img-filters__button--active"),s.classList.remove("img-filters__button--active"),r.classList.add("img-filters__button--active")})))})(),(()=>{const e="Escape";let t=5;const n=document.querySelector(".big-picture"),o=document.querySelector(".big-picture__cancel"),s=document.querySelector("#picture").content,r=n.querySelector(".social__comments"),i=n.querySelector(".comments-loader"),c=n.querySelector(".comments-count"),l=n.querySelector(".social__comment-count");let d=null,a=5,u=5;const m=()=>{const e=document.createDocumentFragment();for(u+=5;t<u;t++){if(!(a<d.comments.length)){i.classList.add("hidden");break}{const n=y({avatar:d.comments[t].avatar,message:d.comments[t].message});a+=1,l.textContent=`${a} из ${d.comments.length} комментариев`,e.appendChild(n)}}r.appendChild(e)},v=()=>{n.classList.add("hidden"),i.classList.remove("hidden"),i.removeEventListener("click",m),a=5,u=5,t=5,document.body.classList.remove("modal-open"),document.removeEventListener("keydown",p)},p=t=>{t.key===e&&(t.preventDefault(),v())},y=e=>{const t=document.createElement("li"),n=document.createElement("img"),o=document.createElement("p");return t.classList.add("social__comment"),n.classList.add("social__picture"),o.classList.add("social__text"),n.src=e.avatar,o.textContent=e.message,t.appendChild(n),t.appendChild(o),t};o.addEventListener("click",v),window.render={renderPicture:e=>{const t=s.cloneNode(!0);return t.querySelector(".picture__img").src=e.url,t.querySelector(".picture__likes").textContent=e.likes,t.querySelector(".picture__comments").textContent=e.comments.length,t},bigPictureRender:e=>{r.textContent="",d=e;const o=n.querySelector(".social__caption"),s=n.querySelector(".big-picture__imgsrc"),a=n.querySelector(".likes-count");o.textContent=e.description,s.src=e.url,a.textContent=e.likes,c.textContent=e.comments.length;const u=document.createDocumentFragment();for(let n=0;n<e.comments.length;n++){const o=y({avatar:e.comments[n].avatar,message:e.comments[n].message});if(e.comments.length>t){if(l.textContent=`5 из ${e.comments.length} комментариев`,u.appendChild(o),4===n)break}else l.textContent=`${e.comments.length}\n         из ${e.comments.length} комментариев`,i.classList.add("hidden"),u.appendChild(o)}r.appendChild(u),i.addEventListener("click",m),document.addEventListener("keydown",p)},bigPicture:n,ESCAPE:e}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector(".img-upload__form"),n=()=>{const t=document.querySelector("#success");window.form.startInitialSettings(),e.appendChild(t.content);const n=e.querySelector(".success"),o=n.querySelector(".success__button");n.classList.remove("hidden");const r=n.querySelector(".success__inner");s(n,o,r)},o=()=>{const t=document.querySelector("#error");window.form.startInitialSettings(),e.appendChild(t.content),window.form.imgUploadOverlay.classList.add("hidden");const n=e.querySelector(".error"),o=n.querySelector(".error__button");n.classList.remove("hidden");const r=n.querySelector(".error__inner");s(n,o,r)},s=(e,t,n)=>{const o=()=>{e.classList.add("hidden"),document.body.classList.remove("modal-open"),t.removeEventListener("click",s),document.removeEventListener("click",i),document.removeEventListener("keydown",r)},s=()=>{o()},r=e=>{e.key===window.render.ESCAPE&&o()},i=e=>{n.contains(e.target)||o()};t.addEventListener("click",s),document.addEventListener("keydown",r),document.addEventListener("click",i)};t.addEventListener("submit",(e=>{e.preventDefault(),window.backend.send(new FormData(t),n,o)}))})(),(()=>{const e=document.querySelector(".text__hashtags"),t=/^\#[а-яА-ЯёЁa-zA-Z0-9]+$/,n=document.querySelector(".text__description");e.addEventListener("input",(()=>{const n=e.value.toLowerCase().split(" ").filter((e=>""!==e)),o=[...new Set(n)];if(n.length>5)e.setCustomValidity("нельзя указать больше пяти хэш-тегов");else if(o.length!==n.length)e.setCustomValidity("один и тот же хэш-тег не может быть использован дважды");else if(""!==e.value)for(let o=0;o<n.length;o++){if("#"!==n[o][0]){e.setCustomValidity("хэш-тег начинается с символа #");break}if("#"===n[o]){e.setCustomValidity("не #");break}if(!t.test(n[o])){e.setCustomValidity("строка после решётки должна состоять из букв и чисел");break}if(n[o].length>20){e.setCustomValidity("максимальная длина одного хэш-тега 20 символов");break}e.setCustomValidity("")}else e.setCustomValidity("")})),n.addEventListener("input",(()=>{140<n.value.length?n.setCustomValidity("максимальная длина коментария 140 символов"):n.setCustomValidity("")})),window.validation={hashtag:e,commentPhoto:n}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=window.form.imgUploadOverlay.querySelectorAll(".effects__preview");window.form.uploadFile.addEventListener("change",(()=>{const n=window.form.uploadFile.files[0],o=n.name.toLowerCase();if(e.some((e=>o.endsWith(e)))){const e=new FileReader,o=()=>{window.form.demonstrationPhoto.src=e.result;for(let n=0;n<t.length;n++)t[n].style.backgroundImage=`url('${e.result} ')`};e.addEventListener("load",o),e.readAsDataURL(n)}}))})()})();