(()=>{"use strict";window.backend={load:(e,t)=>{const n=new XMLHttpRequest;n.responseType="json",n.open("GET","https://21.javascript.pages.academy/kekstagram/data"),n.addEventListener("load",(()=>{let s;switch(n.status){case 200:e(n.response);break;case 400:s="Неверный запрос";break;case 401:s="Пользователь не авторизован";break;case 404:s="Ничего не найдено";break;default:s="Cтатус ответа: : "+n.status+" "+n.statusText}s&&t(s)})),n.addEventListener("error",(()=>{t(n.status)})),n.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+n.timeout+"мс")})),n.timeout=1e4,n.send()},send:(e,t,n)=>{const s=new XMLHttpRequest;s.responseType="json",s.open("POST","https://21.javascript.pages.academy/kekstagram"),s.addEventListener("load",(()=>{200===s.status?t(s.response):n(s.status)})),s.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),s.send(e)}},(()=>{let e=null;window.debounce=t=>(...n)=>{e&&window.clearTimeout(e),e=window.setTimeout((()=>{t(...n)}),500)}})(),(()=>{const e=100,t=document.querySelector(".img-upload__input"),n=document.querySelector(".img-upload"),s=n.querySelector(".img-upload__effect-level"),o=n.querySelectorAll(".effects__radio"),r=n.querySelector("#prewiew__foto"),i=document.body,c=n.querySelector("#upload-cancel"),l=document.querySelector("#upload-file"),d=document.querySelector(".img-upload__overlay"),a=["","grayscale(1)","sepia(1)","invert(100%)","blur(3px)","brightness(3)"];let u=null;const m=["none","effects__preview--chrome","effects__preview--sepia","effects__preview--marvin","effects__preview--phobos","effects__preview--heat"],v=n.querySelector(".effect-level__line"),p=n.querySelector(".effect-level__pin"),y=n.querySelector(".effect-level__depth"),g=n.querySelector(".effect-level__value");let f=25;s.classList.add("hidden");const h=n.querySelector(".scale__control--smaller"),L=n.querySelector(".scale__control--bigger"),w=n.querySelector(".scale__control--value"),_=n.querySelector(".img-upload__preview");let E=100;const k=()=>{_.style.transform="scale(1)",E=100,o[0].checked=!0,window.validation.hashtag.value="",window.validation.commentPhoto.value="",r.style.filter="",r.className="",s.classList.add("hidden"),t.value="",d.classList.add("hidden"),l.value="",w.value="100%",g.value="100"},S=()=>{E>26?(E-=25,w.value=E+"%",_.style.transform=`scale(${E/e})`):(E=25,w.value=E+"%",_.style.transform=`scale(${E/e})`)},b=()=>{E<e?(E+=25,w.value=E+"%",_.style.transform=`scale(${E/e})`):(E=e,w.value=E+"%",_.style.transform=`scale(${E/e})`)};for(let t=0;t<o.length;t++){const n=()=>{r.className="",s.classList.remove("hidden"),r.classList.add(m[t]);for(let t=0;t<a.length;t++)r.classList.contains(m[t])?r.style.filter=a[t]:f!==e?(f=e,p.style.left="100%",y.style.width="100%"):o[0].checked&&(r.className="",s.classList.add("hidden"),r.style.filter="")};o[t].addEventListener("change",n)}const q=()=>{u=e=>{e.preventDefault(),document.body.addEventListener("mousemove",n),document.addEventListener("mouseup",s)};const t=t=>{const n=v.getBoundingClientRect().right,s=v.getBoundingClientRect().left;let r=t.clientX;r>n?r=n:r<s&&(r=s),f=parseInt((r-s)*e/(n-s),10),q.shift=parseInt((r-s)*e/(n-s),10),p.style.left=f+"%",y.style.width=f+"%",g.value=f,document.addEventListener("mousemove",o)},n=t=>{const n=v.getBoundingClientRect().right,s=v.getBoundingClientRect().left;let r=t.clientX;r>n?r=n:r<s&&(r=s),f=parseInt((r-s)*e/(n-s),10),q.shift=parseInt((r-s)*e/(n-s),10),p.style.left=f+"%",y.style.width=f+"%",g.value=f,document.addEventListener("mousemove",o)},s=e=>{e.preventDefault(),document.body.removeEventListener("mousemove",n),document.removeEventListener("mouseup",s),document.removeEventListener("mousemove",o)},o=()=>{const t=["",`grayscale(${f/e})`,`sepia(${f/e})`,`invert(${f}%)`,`blur(${f/33.3333}px)`,`brightness(${1+f/50})`];for(let e=0;e<t.length;e++)r.classList.contains(m[e])&&(r.style.filter=t[e])},a=()=>{k(),i.classList.remove("modal-open"),h.removeEventListener("click",S),L.removeEventListener("click",b),p.removeEventListener("mousedown",u),g.removeEventListener("click",t),document.removeEventListener("keydown",w)},w=e=>{document.activeElement!==window.validation.hashtag&&e.key===window.render.ESCAPE&&document.activeElement!==window.validation.commentPhoto&&e.key===window.render.ESCAPE&&(e.preventDefault(),a())};return l.addEventListener("change",(()=>{d.classList.remove("hidden"),i.classList.add("modal-open"),document.addEventListener("keydown",w),h.addEventListener("click",S),L.addEventListener("click",b),p.addEventListener("mousedown",u),g.addEventListener("click",t)})),c.addEventListener("click",(()=>{a()})),p.addEventListener("mousedown",u),g.addEventListener("click",t),{shift:f,effectLevelPin:p,effectLevelDepth:y,onDocumentKeydown:w}};q(),window.form={imgUpload:n,startInitialSettings:k,imgUploadOverlay:d}})(),(()=>{const e="Enter",t=document.querySelector(".pictures"),n=document.querySelector(".img-filters"),s=n.querySelector("#filter-random"),o=n.querySelector("#filter-default"),r=n.querySelector("#filter-discussed");let i=[],c=[],l=[],d=[];const a=(n,s)=>{const o=document.createDocumentFragment(),r=document.querySelectorAll(".picture");for(let e=0;e<r.length;e++)r[e].remove();for(let t=0;t<s;t++){const s=window.render.renderPicture(n[t]),r=s.querySelector(".picture"),i=e=>{e.preventDefault(),window.render.bigPictureRender(n[t]),window.render.bigPicture.classList.remove("hidden"),document.body.classList.add("modal-open")},c=t=>{t.key===e&&i()};r.addEventListener("keydown",c),r.addEventListener("click",i),o.appendChild(s)}t.appendChild(o)};window.backend.load((s=>{i=s,d=s.slice();const o=document.createDocumentFragment();s.forEach((t=>{const n=window.render.renderPicture(t),s=n.querySelector(".picture");o.appendChild(n),s.addEventListener("keydown",(n=>{n.key===e&&(n.preventDefault(),window.render.bigPictureRender(t),window.render.bigPicture.classList.remove("hidden"),document.body.classList.add("modal-open"))})),s.addEventListener("click",(()=>{window.render.bigPictureRender(t),window.render.bigPicture.classList.remove("hidden"),document.body.classList.add("modal-open")}))})),n.classList.remove("img-filters--inactive"),t.appendChild(o)}),(e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: pink;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="20px",t.style.color="black",t.textContent="ошибка: "+e,document.body.insertAdjacentElement("afterbegin",t)})),s.addEventListener("click",window.debounce((()=>{for(let t=0;t<i.length;t++)c.push(i[Math.floor((0,e=i.length-1,Math.random()*(e-0+1)+0))]),l=[...new Set(c)];var e;a(l,10),s.classList.add("img-filters__button--active"),o.classList.remove("img-filters__button--active"),r.classList.remove("img-filters__button--active"),c=[]}))),o.addEventListener("click",window.debounce((()=>{a(i,i.length),s.classList.remove("img-filters__button--active"),o.classList.add("img-filters__button--active"),r.classList.remove("img-filters__button--active")}))),r.addEventListener("click",window.debounce((()=>{d.sort(((e,t)=>t.comments.length-e.comments.length)),a(d,d.length),s.classList.remove("img-filters__button--active"),o.classList.remove("img-filters__button--active"),r.classList.add("img-filters__button--active")})))})(),(()=>{const e="Escape";let t=5;const n=document.querySelector(".big-picture"),s=document.querySelector(".big-picture__cancel"),o=document.querySelector("#picture").content,r=n.querySelector(".social__comments"),i=n.querySelector(".comments-loader"),c=n.querySelector(".comments-count"),l=n.querySelector(".social__comment-count");let d=null,a=5,u=5;const m=()=>{const e=document.createDocumentFragment();for(u+=5;t<u;t++){if(!(a<d.comments.length)){i.classList.add("hidden");break}{const n=y({avatar:d.comments[t].avatar,message:d.comments[t].message});a+=1,l.textContent=`${a} из ${d.comments.length} комментариев`,e.appendChild(n)}}r.appendChild(e)},v=()=>{n.classList.add("hidden"),i.classList.remove("hidden"),i.removeEventListener("click",m),a=5,u=5,t=5,document.body.classList.remove("modal-open"),document.removeEventListener("keydown",p)},p=t=>{t.key===e&&(t.preventDefault(),v())},y=e=>{const t=document.createElement("li"),n=document.createElement("img"),s=document.createElement("p");return t.classList.add("social__comment"),n.classList.add("social__picture"),s.classList.add("social__text"),n.src=e.avatar,s.textContent=e.message,t.appendChild(n),t.appendChild(s),t};s.addEventListener("click",v),window.render={renderPicture:e=>{const t=o.cloneNode(!0);return t.querySelector(".picture__img").src=e.url,t.querySelector(".picture__likes").textContent=e.likes,t.querySelector(".picture__comments").textContent=e.comments.length,t},bigPictureRender:e=>{r.textContent="",d=e;const s=n.querySelector(".social__caption"),o=n.querySelector(".big-picture__imgsrc"),a=n.querySelector(".likes-count");s.textContent=e.description,o.src=e.url,a.textContent=e.likes,c.textContent=e.comments.length;const u=document.createDocumentFragment();for(let n=0;n<e.comments.length;n++){const s=y({avatar:e.comments[n].avatar,message:e.comments[n].message});if(e.comments.length>t){if(l.textContent=`5 из ${e.comments.length} комментариев`,u.appendChild(s),4===n)break}else l.textContent=`${e.comments.length}\n         из ${e.comments.length} комментариев`,i.classList.add("hidden"),u.appendChild(s)}r.appendChild(u),i.addEventListener("click",m),document.addEventListener("keydown",p)},bigPicture:n,ESCAPE:e}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector(".img-upload__form"),n=()=>{const t=document.querySelector("#success");window.form.startInitialSettings(),e.appendChild(t.content);const n=e.querySelector(".success"),s=n.querySelector(".success__button");n.classList.remove("hidden");const r=n.querySelector(".success__inner");o(n,s,r)},s=()=>{const t=document.querySelector("#error");window.form.startInitialSettings(),e.appendChild(t.content),window.form.imgUploadOverlay.classList.add("hidden");const n=e.querySelector(".error"),s=n.querySelector(".error__button");n.classList.remove("hidden");const r=n.querySelector(".error__inner");o(n,s,r)},o=(e,t,n)=>{const s=()=>{e.classList.add("hidden"),document.body.classList.remove("modal-open"),t.removeEventListener("click",o),document.removeEventListener("click",i),document.removeEventListener("keydown",r)},o=()=>{s()},r=e=>{e.key===window.render.ESCAPE&&s()},i=e=>{n.contains(e.target)||s()};t.addEventListener("click",o),document.addEventListener("keydown",r),document.addEventListener("click",i)};t.addEventListener("submit",(e=>{e.preventDefault(),window.backend.send(new FormData(t),n,s)}))})(),(()=>{const e=document.querySelector(".text__hashtags"),t=/^\#[а-яА-ЯёЁa-zA-Z0-9]+$/,n=document.querySelector(".text__description");e.addEventListener("input",(()=>{const n=e.value.toLowerCase().split(" ").filter((e=>""!==e)),s=[...new Set(n)];if(n.length>5)e.setCustomValidity("нельзя указать больше пяти хэш-тегов");else if(s.length!==n.length)e.setCustomValidity("один и тот же хэш-тег не может быть использован дважды");else if(""!==e.value)for(let s=0;s<n.length;s++){if("#"!==n[s][0]){e.setCustomValidity("хэш-тег начинается с символа #");break}if("#"===n[s]){e.setCustomValidity("не #");break}if(!t.test(n[s])){e.setCustomValidity("строка после решётки должна состоять из букв и чисел");break}if(n[s].length>20){e.setCustomValidity("максимальная длина одного хэш-тега 20 символов");break}e.setCustomValidity("")}else e.setCustomValidity("")})),n.addEventListener("input",(()=>{140<n.value.length?n.setCustomValidity("максимальная длина коментария 140 символов"):n.setCustomValidity("")})),window.validation={hashtag:e,commentPhoto:n}})()})();